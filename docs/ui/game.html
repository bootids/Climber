<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* 核心变量 */
            --bg-primary: #050505;
            --c-text: #e6edf3;
            --c-dim: #666;
            --c-highlight: #58a6ff;
            --c-danger: #ff3333;
            --c-warning: #d29922;
            --c-success: #2ea043;
            
            --c-bpm: #ff3333;    
            --c-o2: #00ffff;   
            --c-san: #bd93f9; 
            --c-nrg: #ffb86c; 
            --c-h2o: #8be9fd;   
            --c-tmp: #ffb000;  

            --glass: rgba(10, 15, 20, 0.85);
            --font-mono: 'Courier New', Courier, monospace;
        }

        /* === 地形/天气主题 (Section 2.1) === */
        body.theme-forest { --bg-primary: #0a1a0a; --c-highlight: #7ee787; } /* 墨绿 */
        body.theme-snow   { --bg-primary: #f0f6fc; --c-text: #0d1117; --glass: rgba(240, 246, 252, 0.9); --c-highlight: #0969da; } /* 刺眼白 (白天) */
        body.theme-snow-night { --bg-primary: #0d1117; --c-highlight: #58a6ff; } /* 普鲁士蓝 (夜晚) */
        body.theme-mud    { --bg-primary: #2a251b; --c-highlight: #d29922; } /* 土黄 */
        body.theme-cave   { --bg-primary: #000000; --c-highlight: #8b949e; } /* 漆黑 */

        * { box-sizing: border-box; user-select: none; }
        
        body { 
            background-color: var(--bg-primary); 
            color: var(--c-text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            height: 100vh; 
            margin: 0; 
            overflow: hidden; 
            display: flex; flex-direction: column;
            transition: background-color 1s ease, filter 2s ease;
        }

        /* === 全屏特效层 (Section 2.2) === */
        .fx-layer { position: absolute; inset: 0; pointer-events: none; z-index: 0; }
        
        /* 扫描线 (Tactical Terminal Feel) */
        .scanlines {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%; z-index: 50; opacity: 0.6;
        }
        
        /* 晕影 & 状态反馈 */
        .vignette {
            background: radial-gradient(circle, transparent 55%, var(--bg-primary) 120%);
            z-index: 40; transition: box-shadow 0.5s;
        }
        .vignette.danger { animation: redPulse 1.5s infinite; } /* 濒死红光 */
        .vignette.frozen { box-shadow: inset 0 0 50px rgba(189, 212, 255, 0.4); } /* 结霜 */

        @keyframes redPulse { 0%,100% { box-shadow: inset 0 0 0 var(--c-danger); } 50% { box-shadow: inset 0 0 60px rgba(255, 51, 51, 0.3); } }

        /* === 顶部 HUD === */
        .top-hud {
            padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;
            font-family: var(--font-mono); font-size: 0.75rem; color: var(--c-highlight);
            background: var(--glass); backdrop-filter: blur(4px); z-index: 60;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* === 叙事流 (Narrative Log) === */
        .log-container {
            flex: 1; padding: 20px; overflow-y: auto; scroll-behavior: smooth;
            mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
            z-index: 10; text-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        .log-container::-webkit-scrollbar { display: none; }
        
        .entry { margin-bottom: 14px; line-height: 1.6; font-size: 0.95rem; opacity: 0.9; position: relative; }
        .entry::before { content: '>'; color: var(--c-dim); margin-right: 8px; font-family: var(--font-mono); }
        
        .sys-text { color: var(--c-dim); font-family: var(--font-mono); font-size: 0.7rem; margin-bottom: 8px; border-left: 2px solid #333; padding-left: 8px; }
        .danger-text { color: var(--c-danger); font-weight: bold; text-shadow: 0 0 5px rgba(255,0,0,0.2); }
        
        /* 故障文字特效 */
        .glitch-text { animation: glitch-skew 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite; color: var(--c-danger); display: inline-block; }
        @keyframes glitch-skew { 0% { transform: skew(0deg); } 20% { transform: skew(-10deg); } 40% { transform: skew(10deg); } 60% { transform: skew(-5deg); } 80% { transform: skew(5deg); } 100% { transform: skew(0deg); } }

        /* === 底部仪表盘 (Dashboard) === */
        .dashboard {
            background: var(--glass);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 15px; z-index: 60;
            display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.3);
        }

        /* 状态网格 */
        .status-grid {
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            grid-template-rows: auto auto;
            gap: 10px;
        }

        .stat-item {
            display: flex; flex-direction: column; justify-content: center;
        }

        .stat-header { 
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 0.65rem; color: var(--c-dim); margin-bottom: 4px; font-family: var(--font-mono);
        }
        
        /* 微型进度条 */
        .bar-track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        .bg-bpm { background: var(--c-bpm); } .c-bpm { color: var(--c-bpm); }
        .bg-o2 { background: var(--c-o2); } .c-o2 { color: var(--c-o2); }
        .bg-san { background: var(--c-san); } .c-san { color: var(--c-san); }
        .bg-nrg { background: var(--c-nrg); } .c-nrg { color: var(--c-nrg); }
        .bg-h2o { background: var(--c-h2o); } .c-h2o { color: var(--c-h2o); }
        .bg-tmp { background: var(--c-tmp); } .c-tmp { color: var(--c-tmp); }

        /* 导航与操作区 */
        .nav-control-row { display: flex; gap: 15px; height: 90px; }

        /* 战术地图 (Circular Watch Face) */
        .map-container {
            width: 90px; height: 90px; flex-shrink: 0;
            position: relative;
        }
        .map-frame {
            width: 100%; height: 100%; border-radius: 50%;
            border: 2px solid #333; background: #000;
            overflow: hidden; position: relative;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .map-glass-glare {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none; z-index: 5;
        }
        canvas { display: block; }

        /* 海拔剖面 (Elevation Profile) - 简化为地图下方的小条或整合在侧边 */
        .elevation-indicator {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            z-index: 4; pointer-events: none;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .wave-line { width: 80%; height: 10px; border-top: 1px solid var(--c-highlight); opacity: 0.5; }

        /* 操作按钮 */
        .action-panel { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        
        .btn-main {
            flex: 1; background: var(--c-text); color: var(--bg-primary); border: none; border-radius: 6px;
            font-size: 1.1rem; font-weight: 900; letter-spacing: 1px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .btn-main:active { transform: scale(0.98); filter: brightness(0.9); }
        .btn-sub-text { font-size: 0.6rem; font-weight: normal; opacity: 0.7; margin-top: 4px; font-family: var(--font-mono); }
        
        /* 辅助按钮行 */
        .sub-actions { display: flex; gap: 8px; height: 32px; }
        .btn-mini { 
            flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); 
            color: var(--c-text); border-radius: 4px; font-size: 0.75rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-mini:active { background: rgba(255,255,255,0.2); }

        /* 缺氧模糊滤镜 */
        .hypoxia-blur { filter: blur(3px) contrast(1.2); }
        
    </style>
</head>
<body class=""> <!-- theme class here -->

    <div class="fx-layer scanlines"></div>
    <div class="fx-layer vignette" id="vignette"></div>

    <div class="top-hud">
        <span><i class="fas fa-mountain"></i> <span id="elevation">5,200</span>m</span>
        <span id="weatherState" style="opacity:0.8"><i class="far fa-snowflake"></i> BLIZZARD</span>
    </div>

    <div class="log-container" id="logBox">
        <div class="sys-text">
            > TERMINAL_OS_v4.0<br>
            > CONNECTED: SAT_UPLINK_03<br>
            > WEATHER_WARNING: SEVERE
        </div>
        <div class="entry">
            风在咆哮。这里的空气稀薄得像是在抽真空。每一步都需要调动全身的意志力。
        </div>
    </div>

    <div class="dashboard">
        
        <!-- 状态数值 -->
        <div class="status-grid">
            <div class="stat-item">
                <div class="stat-header">
                    <span>BPM</span> <i class="fas fa-heartbeat c-bpm"></i>
                </div>
                <div class="bar-track"><div class="bar-fill bg-bpm" id="barBpm" style="width: 60%;"></div></div>
            </div>
            
            <div class="stat-item">
                <div class="stat-header">
                    <span>O₂</span> <i class="fas fa-lungs c-o2"></i>
                </div>
                <div class="bar-track"><div class="bar-fill bg-o2" id="barO2" style="width: 85%;"></div></div>
            </div>

            <div class="stat-item">
                <div class="stat-header">
                    <span>SAN</span> <i class="fas fa-brain c-san"></i>
                </div>
                <div class="bar-track"><div class="bar-fill bg-san" id="barSan" style="width: 90%;"></div></div>
            </div>

            <div class="stat-item">
                <div class="stat-header">
                    <span>NRG</span> <span class="c-nrg" id="valNrg">72%</span>
                </div>
                <div class="bar-track"><div class="bar-fill bg-nrg" id="barNrg" style="width: 72%;"></div></div>
            </div>

            <div class="stat-item">
                <div class="stat-header">
                    <span>H₂O</span> <span class="c-h2o" id="valH2o">64%</span>
                </div>
                <div class="bar-track"><div class="bar-fill bg-h2o" id="barH2o" style="width: 64%;"></div></div>
            </div>

            <div class="stat-item">
                <div class="stat-header">
                    <span>TMP</span> <span class="c-tmp" id="valTmp">-5°</span>
                </div>
                <div class="bar-track"><div class="bar-fill bg-tmp" id="barTmp" style="width: 40%;"></div></div>
            </div>
        </div>

        <!-- 导航与核心操作 -->
        <div class="nav-control-row">
            <div class="map-container" onclick="toggleMapMode()">
                <div class="map-frame">
                    <canvas id="mapCanvas" width="180" height="180"></canvas>
                    <div class="elevation-indicator"><div class="wave-line"></div></div>
                </div>
                <div class="map-glass-glare"></div>
            </div>
            
            <div class="action-panel">
                <button class="btn-main" id="btnMove" onclick="handleMove()">
                    <span id="txtMoveMain">前 进</span>
                    <span class="btn-sub-text" id="txtMoveSub">消耗 120 KP</span>
                </button>
                
                <div class="sub-actions">
                    <button class="btn-mini" id="btnRest" onclick="handleRest()"><i class="fas fa-campground"></i> <span>扎营</span></button>
                    <button class="btn-mini" id="btnItem" onclick="handleItem()"><i class="fas fa-briefcase"></i> <span>物品</span></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === Game State ===
        const gameState = {
            season: 'winter', // spring, summer, autumn, winter
            weather: 'blizzard',
            elevation: 5200,
            
            // Resources
            kp: 8402, // Kinetic Potential
            
            // Stats
            bpm: 110,
            spo2: 85,
            san: 90, // Max 100
            nrg: 72,
            h2o: 64,
            tmp: 36.0,

            // Navigation
            offset: 0, // Lateral Offset (Meters from center)
            headingError: 0, // Vector Decoupling angle
            isLost: false
        };

        // === 1. Map System (Canvas) ===
        const cvs = document.getElementById('mapCanvas');
        const ctx = cvs.getContext('2d');
        let mapFrame = 0;

        function drawMap() {
            // Clear
            ctx.fillStyle = "#000";
            ctx.fillRect(0,0,180,180);

            const cx = 90, cy = 90;

            // Grid / Radar lines
            ctx.strokeStyle = "#222";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(cx, cy, 30, 0, Math.PI*2);
            ctx.arc(cx, cy, 60, 0, Math.PI*2);
            ctx.stroke();
            
            // Centerline (The "Correct" Path)
            // If Lost/Fog, this fades out
            let pathOpacity = gameState.isLost ? 0.1 : 0.8;
            if (gameState.weather === 'fog') pathOpacity *= 0.5;

            ctx.save();
            ctx.beginPath();
            ctx.strokeStyle = `rgba(88, 166, 255, ${pathOpacity})`; // Brand Blue
            ctx.lineWidth = 3;
            ctx.moveTo(cx, 180);
            // Bezier curve for path
            ctx.bezierCurveTo(cx - 20, 140, cx + 20, 60, cx, 0);
            ctx.stroke();
            ctx.restore();

            // Ghost Path (Hallucination)
            if (gameState.san < 20) {
                ctx.save();
                ctx.setLineDash([5, 5]);
                ctx.strokeStyle = `rgba(255, 50, 50, ${Math.random() * 0.8})`; // Red glitch
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.lineTo(cx + 60, 0); // Leads to danger
                ctx.stroke();
                ctx.restore();
            }

            // Player Arrow / Dot
            // Calculate visual position based on Offset
            // If offset > 0, player moves right.
            let px = cx + (gameState.offset * 0.5); 
            // Clamp px
            if (px > 170) px = 170; if (px < 10) px = 10;

            ctx.save();
            ctx.translate(px, cy);
            
            // Rotation based on Heading Error (Vector Decoupling)
            let rotation = gameState.headingError * (Math.PI / 180);
            ctx.rotate(rotation);

            // Draw Arrow
            ctx.fillStyle = "#fff";
            ctx.beginPath();
            ctx.moveTo(0, -6);
            ctx.lineTo(5, 5);
            ctx.lineTo(0, 3);
            ctx.lineTo(-5, 5);
            ctx.fill();
            ctx.restore();

            // Fog / Noise Overlay (Visual Static)
            if (mapFrame % 3 === 0) {
                ctx.fillStyle = `rgba(0,0,0,${Math.random() * 0.1})`;
                ctx.fillRect(0,0,180,180);
            }

            mapFrame++;
            requestAnimationFrame(drawMap);
        }

        // === 2. UI & Text Tampering (Section 8.3) ===
        function updateUI() {
            // Bars
            document.getElementById('barBpm').style.width = Math.min((gameState.bpm - 40)/1.6, 100) + '%';
            document.getElementById('barO2').style.width = gameState.spo2 + '%';
            document.getElementById('barSan').style.width = gameState.san + '%';
            document.getElementById('barNrg').style.width = gameState.nrg + '%';
            document.getElementById('valNrg').innerText = gameState.nrg + '%';
            document.getElementById('barH2o').style.width = gameState.h2o + '%';
            document.getElementById('valH2o').innerText = gameState.h2o + '%';
            
            // Temp Color logic
            const tempEl = document.getElementById('valTmp');
            tempEl.innerText = gameState.tmp.toFixed(1) + '°';
            if (gameState.tmp < 35) tempEl.classList.add('danger-text');
            
            // Elevation
            document.getElementById('elevation').innerText = gameState.elevation.toLocaleString();

            // Dynamic Text Tampering (SAN Check)
            if (gameState.san < 20) {
                tamperText();
                document.getElementById('vignette').classList.add('danger');
            } else {
                restoreText();
                document.getElementById('vignette').classList.remove('danger');
            }

            // Hypoxia
            if (gameState.spo2 < 60) {
                document.body.classList.add('hypoxia-blur');
            } else {
                document.body.classList.remove('hypoxia-blur');
            }
        }

        function tamperText() {
            // Section 8.3 Logic
            const season = gameState.season;
            const btnMove = document.getElementById('txtMoveMain');
            const btnRest = document.querySelector('#btnRest span');
            
            if (season === 'winter') {
                // Winter Hallucinations
                if (Math.random() > 0.7) btnMove.innerHTML = "<span class='glitch-text'>走入风雪</span>";
                if (Math.random() > 0.7) btnRest.innerHTML = "长眠";
            } else if (season === 'summer') {
                 // Summer Hallucinations
                if (Math.random() > 0.7) btnMove.innerHTML = "追逐太阳";
                if (Math.random() > 0.7) btnRest.innerHTML = "融化";
            }
        }

        function restoreText() {
            document.getElementById('txtMoveMain').innerText = "前 进";
            document.querySelector('#btnRest span').innerText = "扎营";
        }

        // === 3. Game Actions ===
        function handleMove() {
            if (gameState.kp < 10) {
                addLog("KP不足。请同步现实步数。", true);
                return;
            }
            
            // Cost
            let cost = 120; // Base cost per meter/step chunk
            gameState.kp -= cost;
            
            // Stats impact
            gameState.bpm += 5;
            gameState.nrg -= 2;
            gameState.h2o -= 3;
            gameState.elevation += Math.floor(Math.random() * 5);
            
            // SAN Check
            if (Math.random() > 0.8) gameState.san -= 5;

            // Getting Lost Logic (Vector Decoupling)
            if (Math.random() > 0.9 && !gameState.isLost) {
                gameState.isLost = true;
                gameState.headingError = 30; // 30 degree deviation
                addLog("警告：磁场异常，导航系统解耦。", true);
            }

            if (gameState.isLost) {
                // Increase offset if moving while lost
                gameState.offset += 5; 
            }

            updateUI();
            
            // Narrative
            const narratives = [
                "积雪在脚下嘎吱作响。",
                "风声像是某种生物的呜咽。",
                "呼吸面罩结冰了。",
                "心率过快，建议放缓节奏。"
            ];
            addLog(narratives[Math.floor(Math.random() * narratives.length)]);
        }

        function handleRest() {
            gameState.bpm = 70;
            gameState.san += 10;
            if (gameState.san > 100) gameState.san = 100;
            addLog("你挖了个雪洞暂时休息。体温略微回升。");
            updateUI();
        }
        
        function handleItem() {
            addLog("打开背包...");
            // Link to inventory.html in real app
        }

        // Log System
        const logBox = document.getElementById('logBox');
        function addLog(text, isDanger = false) {
            const div = document.createElement('div');
            div.className = isDanger ? 'entry danger-text' : 'entry';
            div.innerHTML = text;
            logBox.appendChild(div);
            logBox.scrollTop = logBox.scrollHeight;
        }

        // Init
        drawMap();
        updateUI();

        // Simulate environment changes (Demo)
        setInterval(() => {
            // Randomly fluctuate heart rate
            gameState.bpm += Math.floor((Math.random() - 0.5) * 4);
            updateUI();
        }, 2000);

    </script>
</body>
</html>